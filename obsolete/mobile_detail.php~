<html>
<head>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<meta name="description" content="" />

<meta name="keywords" content="" />

<meta name="author" content="" />

<link rel="stylesheet" type="text/css" href="styles/mobile.css" media="screen" />

<?php include('variables/variables.php'); ?>
<?php include('includes/check_rights.php'); ?>
<?php session_start(); 

//Once set times are finalized, run the time update script. This will convert the set start and times into php time
//Find bands to display

//Get all bands that are playing starting ten minutes from now until 2 hours from now

//For temporary testing purposes, $now is fixed

//Because bands run past midnight but are still considered the prior day, we figure out the day first.
//The following varaibles gives the time that the day is considered to change

//echo strtotime("12 April 2013 11:55"), " Friday <br>";
//echo strtotime("12 April 2013 17:55"), " Friday <br>";
$current = date("M-d-Y G:i", time());

$day_start = "8:00";




$sql = "";

?>
<title>Should I check out...</title>

</head>
<body>



<?php
$right_required = "ViewNotes";
If(isset($_SESSION['level']) && CheckRights($_SESSION['level'], $right_required)){

	If ($_REQUEST["band"]) {
		echo "<p><a href=\"".$basepage."?disp=view_band\">Click here to view a different band.</a></p>";
	}

	mysql_connect($dbhost,$dbuser,$dbpw);
	@mysql_select_db($dbname) or die( "Unable to select database");

	$band = $_REQUEST["band"];

	If($band){
	$query="SELECT AVG(rating) AS avg FROM `ratings` WHERE band='$band'";
	$query_rating = mysql_query($query);
	$rating_row = mysql_fetch_assoc($query_rating);
	$query="SELECT SUM(clicks) AS clicks FROM `links` WHERE band='$band'";
	$query_link = mysql_query($query);
	$link_row = mysql_fetch_assoc($query_link);
	$query="SELECT Users.username AS username, Users.username AS name, rating, comment, descrip, links.id as link FROM Users LEFT JOIN ratings ON Users.id=ratings.user AND ratings.band='$band' LEFT JOIN comments ON Users.id=comments.user AND comments.band='$band' LEFT JOIN links ON Users.id=links.user AND links.band='$band' GROUP BY Users.id";
	
	$query_comment = mysql_query($query);

//Gets the current average rating
$sql_curr_avg = "select avg(rating) as average from ratings left join bands on ratings.band=bands.id";

$res = mysql_query($sql_curr_avg);
$curr_avg_rate = mysql_fetch_assoc($res);
$avg_rating = $curr_avg_rate['average'];

//Returns current band info
$sql_score_up = "select days.date as stime, days.date as etime, stages.name as stage, ratings.band as id, bands.name as name, avg(rating) as average, count(rating), ((count(rating)-1)*.05+1)*(avg(rating)-$avg_rating) as score from bands left join ratings on bands.id=ratings.band left join stages on bands.stage=stages.id left join days on bands.day=days.id where bands.id=$band group by ratings.band";

$res = mysql_query($sql_score_up);

$band_row = mysql_fetch_array($res);

$time_untils = strtotime($band_row['stime']) - time();
$time_untile = strtotime($band_row['etime']) - time();

$time_untils = round($time_untils/60/60/24, 0);
$time_untile = round($time_untile/60, 0);

//Remeber to change this expression to minutes close to gametime!
If($time_untils > 0 ) $disp_str = $time_untils." days until start";
If($time_untils <= 0 ) $disp_str = $time_untile." min left";
?>

<div id="header_container">
    <div id="header">
        <?php echo $band_row["name"]; ?>
    </div>
</div>

<div id="band_details">


<table border="1">
<tr>
<th>band name</th>
<th>average rating</th>
<th>start time</th>
<th>end time</th>
</tr>
<tr>
<td><?php echo $band_row['name']; ?></td>
<td><?php echo $rating_row['avg']; ?></td>
<td><?php echo substr($band_row['stime'], 11, 5); ?></td>
<td><?php echo substr($band_row['etime'], 11, 5); ?></td>
</tr>
</table>

<?php

$i = 1;
while ($comment_row = mysql_fetch_assoc($query_comment)) {

//This If statement ensures that there is data to display
If( $comment_row['rating'] || $comment_row['comment'] || $comment_row['link'] ) {

	If( $comment_row['username'] == $_SESSION['user'] ) {
		$i_ret = $i;
		$i = 0;
	}

	$table[$i] = "<table border=1><tr><th>User:</th><td>";
	$table[$i] .= $comment_row['name'];


	$table[$i] .= "</td></tr><tr><th>Rating:</th><td>";

	$table[$i] .= $comment_row['rating'];	


	$table[$i] .= "</td></tr><tr><th colspan=2>Comment:</th></tr><tr><td colspan=2>";

	$table[$i] .= $comment_row['comment'];
	$table[$i] .= "</td></tr></table>";

	If( $comment_row['username'] == $_SESSION['user'] ) {
		$i = $i_ret;
	}
$i_max = $i;
$i = $i +1;
//Closes the If loop preventing users with no data from being displayed
}	

//Closes the while loop
}


If(!isset($i_ret)){
	

	foreach ($table as $val) {
		echo "<br>".$val."<br>";
	}
} else {

	for ($i=0; $i<=$i_max; $i++) {
		If(isset($table[$i])) {
			echo "<br>".$table[$i]."<br>";
		}
	}

}

} else {

	$query="select name, id from bands";
	$query_band = mysql_query($query);
?>
<form action="mobile_detail.php" method="get">
<select name="band">
<?php 
while($row = mysql_fetch_array($query_band)) {
	echo "<option value=".$row['id'].">".$row['name']."</option>";
}
	
?>
</select>
<input type="submit">
</form>
</div>

<?php
	}

mysql_close();
}
else{
?>
<p>

You do not have sufficient access rights to view this page.

<a class="loginlink" href="<?php echo $basepage; ?>?disp=login">Log In</a>

</p>

<?php 
}

?>




<div id="footer_container">
    <div id="footer">
        <div class="time">
	<?php echo $disp_str; ?>
	</div>
        <div class="stage">
	<?php echo $band_row["stage"]; ?>
	</div>
        <div class="score">
	<?php echo $band_row["score"]; ?>
	</div>
    </div>
</div>

</body>
</html>
