<div id="filter">

<?php
//Set up the fields that will be used for the query

$select = "SELECT bands.name AS name, bands.id AS id, bands.start as stime, bands.end as etime ";
$from = "FROM bands ";
$where = "WHERE ";
$order = " ORDER BY ";
$where_active = 0;
$sort_active = 0;

?>

<p>
Filters:<a class="helplink" href="<?php echo $basepage; ?>?disp=about#filters">Click here for help with this section</a>
</p>
<form name="filters" action="<? echo $post_target; ?>" method="post">
<div id="filterday" class="filtersection">
<p>
Filter by day:
<ul>
<?php
while($row = mysql_fetch_array($query_day)) {
	echo "<li><input type=\"checkbox\" name=\"day[]\" value=\"".$row["id"]."\">".$row["name"]."</li>";
}
?>
</ul>
</p>
</div><!-- End #filterday -->

<div id="filterstage" class="filtersection">
<p>
Filter by stage:
<ul>
<?php
while($row = mysql_fetch_array($query_stage)) {
	echo "<li><input type=\"checkbox\" name=\"stage[]\" value=\"".$row["id"]."\">".$row["name"]."</li>";
}
?>
</ul>
</p>
</div><!-- End #filterstage -->

<div id="sortorder" class="filtersection">
<p>
Sort order:
<ul>
<li><input type="checkbox" name="sort[]" value="name">Alphabetically</li>
<li><input type="checkbox" name="sort[]" value="stime">By start time</li>
<li><input type="checkbox" name="sort[]" value="etime">By end time</li>
<li><input type="checkbox" name="sort[]" value="added">By date added</li>
<li><input type="checkbox" name="sort[]" value="invert">Reverse the selected sort order</li>
</ul>
</p>
</div><!-- End #sortorder -->

<div id="filtertime" class="filtersection">
<p>
Filter by time:
<ul>
<li><input type="checkbox" name="time[]" value="now">Playing now</li>
<li><input type="checkbox" name="time[]" value="onehour">In the next hour</li>
<li><input type="checkbox" name="time[]" value="twohour">In the next 2 hours</li>
</ul>
</p>
</div><!-- End #filtertime -->

<div id="filtercomment" class="filtersection">
<p>
Filter by comments:
<ul>
<li><input type="checkbox" name="comments[]" value="ihave">Bands I HAVE commented on</li>
<li><input type="checkbox" name="comments[]" value="ihavenot">Bands I HAVE NOT commented on</li>
<li><input type="checkbox" name="comments[]" value="none">Bands with NO comments</li>
<li><input type="checkbox" name="comments[]" value="someone">Bands SOMEONE has commented on</li>
<li><input type="checkbox" name="comments[]" value="many">Bands with several comments</li>
</ul>
</p>
</div><!-- End #filtercomment -->

<div id="filterrating" class="filtersection">
<p>
Filter by ratings:
<ul>
<li><input type="checkbox" name="ratings[]" value="ihave">Bands I HAVE rated</li>
<li><input type="checkbox" name="ratings[]" value="ihavenot">Bands I HAVE NOT rated</li>
<li><input type="checkbox" name="ratings[]" value="none">Bands NO ONE has rated</li>
<li><input type="checkbox" name="ratings[]" value="many">Bands many people have rated</li>
<li><input type="checkbox" name="ratings[]" value="high">Bands with a high rating</li>
<li><input type="checkbox" name="ratings[]" value="low">Bands with a low rating</li>
</ul>
</p>
</div><!-- End #filterrating -->

<div id="filterlink" class="filtersection">
<p>
Filter by links:
<ul>
<li><input type="checkbox" name="links[]" value="ihave">Bands I HAVE linked</li>
<li><input type="checkbox" name="links[]" value="ihavenot">Bands I HAVE NOT linked</li>
<li><input type="checkbox" name="links[]" value="none">Bands NO ONE has linked</li>
<li><input type="checkbox" name="links[]" value="someone">Bands SOMEONE has linked</li>
<li><input type="checkbox" name="links[]" value="many">Bands many people have linked</li>
</ul>
</p>
</div><!-- End #filterlink -->

<div id="empty1" class="filtersection">
<p>

</p>
</div><!-- End #empty1 -->

<div id="empty2" class="filtersection">
<p>

</p>
</div><!-- End #empty2 -->

<br />


<input type="submit" value="Show my bands">
</form>
<?php


//Pull the POST data into regular arrays
if(!empty($_POST['day'])) {
	$where .= MatchFilter($_POST['day'], "day", "bands");
	$where_active = 1;
}

if(!empty($_POST['stage'])) {
    foreach($_POST['stage'] as $check) {
            $stage[]= $check;
    }
}

if(!empty($_POST['time'])) {
    foreach($_POST['time'] as $check) {
            $time[]= $check;
    }
}

if(!empty($_POST['comments'])) {
    foreach($_POST['comments'] as $check) {
            $comments[]= $check;
    }
}

if(!empty($_POST['ratings'])) {
    foreach($_POST['ratings'] as $check) {
            $ratings[]= $check;
    }
}

if(!empty($_POST['links'])) {
    foreach($_POST['links'] as $check) {
            $links[]= $check;
    }
}



//process filters

if(!empty($stage)) {
	If ($where_active == 1) $where .= " AND ";
	$where .= MatchFilter($stage, "stage", "bands");
	$where_active = 1;
}

if(!empty($time)) {
    foreach($time as $check) {
            echo "Time condition ".$check." is selected.<br>";
    }
}

if(!empty($comments)) {
    foreach($comments as $check) {

	If ($check == "ihave") {
	echo "Displaying bands I have commented on.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalIncludeFilter("id", "bands", "band", "comments", "user", $userid);
		$where_active = 1;
	}


	If ($check == "ihavenot") {
	echo "Displaying bands I have not commented on.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalExcludeFilter("id", "bands", "band", "comments", "user", $userid);
		$where_active = 1;
	}

	If ($check == "none") {
	echo "Displaying bands no one has commented on.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalExcludeFilter("id", "bands", "band", "comments", "'1'", "1");
		$where_active = 1;

	}

	If ($check == "someone") {
	echo "Displaying bands someone has commented on.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalIncludeFilter("id", "bands", "band", "comments", "'1'", "1");
		$where_active = 1;

	}

	If ($check == "many") {
	echo "Displaying bands many have commented on.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalMinimumFilter("id", "bands", "band", "comments", "count(*)", "2");
		$where_active = 1;

	}
    }
}



if(!empty($ratings)) {

	foreach($ratings as $check) {
		If ($where_active == 1) $where .= " AND ";
		switch ($check)

{
case "ihave":
	echo "Displaying bands I have rated.<br>";
	$where .= ExternalIncludeFilter("id", "bands", "band", "ratings", "user", $userid);
  break;
case "ihavenot":
	echo "Displaying bands I have not rated.<br>";
		$where .= ExternalExcludeFilter("id", "bands", "band", "ratings", "user", $userid);
  break;
case "none":
	echo "Displaying bands no one has rated.<br>";
	$where .= ExternalExcludeFilter("id", "bands", "band", "ratings", "'1'", "1");
  break;
case "someone":
	echo "Displaying bands someone has rated.<br>";
	$where .= ExternalIncludeFilter("id", "bands", "band", "ratings", "'1'", "1");
  break;
case "many":
	echo "Displaying bands many have rated.<br>";
	$where .= ExternalMinimumFilter("id", "bands", "band", "ratings", "count(*)", "2");
  break;
case "high":
	echo "Displaying bands with a high rating.<br>";
	$where .= ExternalMinimumFilter("id", "bands", "band", "ratings", "avg(rating)", "3.5");
  break;
case "low":
	echo "Displaying bands with a low rating.<br>";
	$where .= ExternalMaximumFilter("id", "bands", "band", "ratings", "avg(rating)", "2.5");
  break;
}
$where_active = 1;
	}
}

if(!empty($links)) {

    foreach($links as $check) {

	If ($check == "ihave") {
	echo "Displaying bands I have linked.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalIncludeFilter("id", "bands", "band", "links", "user", $userid);
		$where_active = 1;
	}


	If ($check == "ihavenot") {
	echo "Displaying bands I have not linked.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalExcludeFilter("id", "bands", "band", "links", "user", $userid);
		$where_active = 1;
	}

	If ($check == "none") {
	echo "Displaying bands no one has linked.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalExcludeFilter("id", "bands", "band", "links", "'1'", "1");
		$where_active = 1;

	}

	If ($check == "someone") {
	echo "Displaying bands someone has linked.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalIncludeFilter("id", "bands", "band", "links", "'1'", "1");
		$where_active = 1;

	}

	If ($check == "many") {
	echo "Displaying bands many have linked.<br>";

		If ($where_active == 1) $where .= " AND ";
		$where .= ExternalMinimumFilter("id", "bands", "band", "links", "count(*)", "2");
		$where_active = 1;

	}
    }
}


if(!empty($_POST['sort'])) {



	foreach($_POST['sort'] as $check) {
		switch ($check)

		{
			case "name":
				If( $sort_active != 1) {
					echo "Bands sorted alphabetically.<br>";
					$order .= "name ";
					$sort_active = 1;
				}
  				break;
			case "stime":
				If( $sort_active != 1) {
					echo "Bands sorted by start time.<br>";
					$order .= "stime ";
					$sort_active = 1;
				}
				break;
			case "etime":
				If( $sort_active != 1) {
					echo "Bands sorted by end time.<br>";
					$order .= "etime ";
					$sort_active = 1;
				}
				break;
			case "added":
				If( $sort_active != 1) {
					echo "Bands sorted by date added to the system.<br>";
					$order .= "id ";
					$sort_active = 1;
				}
				break;
			case "invert":
				If( $sort_active == 1) {
					echo "Sort order is reversed.<br>";
					$order .= "desc";
				}
				break;
		} //Close Switch case
	} //Close foreach
}//Close If



//compose query

$sql = $select;
$sql .= $from;

If(strlen($where) > 6) $sql .= $where;
If($sort_active == 1) $sql .= $order;

// echo "<br>$sql<br>";

$result = mysql_query($sql);


?>
</div><!-- End #filter -->
